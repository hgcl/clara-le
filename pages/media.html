<!--
template: /templates/default.html
buildScript: /scripts/buildMediaPage.js
-->

<section id="media">
  <h1>Media</h1>
  <p class="intro">
    A curated and non-exhaustive list of books, movies and series I liked and
    would recommend.
  </p>
  <div id="posts-filter">
    <span class="sr-only">Select filters:</span>
    <button
      type="button"
      class="selectedTag"
      id="all"
      value="all"
      onclick="filterItems(value);"
    >
      All
    </button>
    <button type="button" id="book" value="book" onclick="filterItems(value);">
      Books
    </button>
    <button
      type="button"
      id="movie"
      value="movie"
      onclick="filterItems(value);"
    >
      Movies
    </button>
    <button
      type="button"
      id="tv-series"
      value="tv-series"
      onclick="filterItems(value);"
    >
      TV series
    </button>
  </div>
  <p>Posts go here</p>
</section>

<script>
  // lazy loading from https://www.audreyhal.com/blog/lazy-loading-images-with-intersection-observer-api
  // Create an observer instance and pass the callback and possible options
  const observer = new IntersectionObserver(callback);
  // Since we have multiple images we'd like to observe, we can create an array containing each image
  const lazyImages = [].slice.call(document.querySelectorAll(".lazy-image"));
  // Loop through the image array and pass each image as a target element to the observer
  lazyImages.forEach((lazyImage) => {
    observer.observe(lazyImage);
  });
  function callback(entries, observer) {
    entries.forEach((entry) => {
      const target = entry.target;
      const dataSrc = target.getAttribute("data-src");
      if (entry.isIntersecting) {
        // put the desired url(dataSrc) as the src
        target.setAttribute("src", dataSrc);
        target.removeAttribute("data-src");
        // stop observing the element
        observer.unobserve(target);
      }
    });
  }

  // Same filter script as posts.html
  // Set variables
  const completeLiList = [...document.querySelectorAll(`li[data-tag]`)];
  let selectedtag = "all";
  const allButtons = document.querySelectorAll("#posts-filter button");

  function filterItems(param) {
    if (param) {
      // Update URL onclick
      updateURL(param);
    }

    // Update CSS of current button and reset other buttons styles
    allButtons.forEach((button) => {
      button.removeAttribute("class");
    });
    const clickedButton = document.getElementById(param);
    clickedButton.setAttribute("class", "selectedTag");

    // Hide list items based on updated tags list
    let i = 0;
    while (i < completeLiList.length) {
      // Select <li> number i and get its tags
      let itemTags = completeLiList[i]
        .getAttribute("data-tag")
        .toLowerCase()
        .replace(" ", "-");
      // Hide <li> if it doesn't include the selected param
      if ((param === "all") | (itemTags.includes(param) === true)) {
        completeLiList[i].setAttribute("style", "display:flex");
      } else {
        completeLiList[i].setAttribute("style", "display:none");
      }
      i++;
    }
  }

  // Get current URL and apply filter to open page if necessary
  let currentUrl = new URL(window.location.href);
  const searchParams = new URLSearchParams(currentUrl.search);
  filterItems(searchParams.get("q"));

  // Align selected filter with URL
  function updateURL(filter) {
    // Update URL
    currentUrl.searchParams.set("q", filter);
    history.pushState({}, "", currentUrl);
  }
</script>
