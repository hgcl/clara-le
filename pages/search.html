<!--
template: /templates/default.html
title: "Search"
-->

<div id="search">
  <form id="search-form" role="search">
    <label for="search-bar">Search</label>
    <input
      type="search"
      id="search-bar"
      autocomplete="none"
      autocorrect="none"
      autocapitalize="none"
      spellcheck="false"
    />
    <input type="reset" value="Reset" />
    <button>Search</button>
  </form>
  <ul class="song-list"></ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/minisearch@6.3.0/dist/umd/index.min.js"></script>
<script type="module">
  import documents from "/postIndex.js";

  // Select DOM elements
  const searchPage = document.querySelector("#search");
  const searchForm = document.querySelector("#search-form");
  const searchInput = document.querySelector("#search-bar");
  const songList = document.querySelector(".song-list");

  // Set up minisearch
  let miniSearch = new MiniSearch({
    fields: ["title", "text"], // fields to index for full-text search
    storeFields: ["title", "category"], // fields to return with search results
  });

  // Fetch and index all documents
  miniSearch.addAll(documents);
  //   const json = JSON.stringify(miniSearch);
  //   console.log("json: " + json);

  // Typing into search bar updates search results and suggestions
  searchForm.addEventListener("submit", (event) => {
    event.preventDefault(); // prevents search input being cleared on submit
    const query = searchInput.value;
    const results = query.length > 1 ? getSearchResults(query) : [];
    renderSearchResults(results);
    console.log("final results: " + JSON.stringify(results));
  });

  const getSearchResults = (query) => {
    return miniSearch.search(query);
  };

  const renderSearchResults = (results) => {
    songList.innerHTML = results
      .map(({ title, category }) => {
        return `<li class="Song">
      <h3>${title}</h3>
      <dl>
        <dt>Category:</dt> <dd>${category}</dd>
      </dl>
    </li>`;
      })
      .join("\n");

    if (results.length > 0) {
      searchPage.classList.add("hasResults");
    } else {
      searchPage.classList.remove("hasResults");
    }
  };
</script>
